---
title: "Cycling Interventions Evaluation"
subtitle: "R Code"
author:
- "Richard Wen richard.wen@utoronto.ca"
- "Brice Batomen brice.kuimi@utoronto.ca"
- "Linda Rothman linda.rothman@torontomu.ca"
- "Andrew Howard andrew.howard@sickkids.ca"
date: "`r format(Sys.time(), '%B %d, %Y')`"
knit: |
    (function(input_rmd, ...) {
    rmarkdown::render(
        input_rmd,
        rmarkdown::html_document(
            toc = TRUE,
            toc_float = TRUE,
            highlight = "zenburn",
            code_folding = "hide",
            df_print = "paged",
            self_contained = FALSE
        ),
        output_dir = "../docs",
        output_file = "index", ...)
    })
---

```{r include = FALSE, echo = FALSE}
knitr::opts_chunk$set(
	warning = FALSE,
	message = FALSE
)
```

# Installation

1.  Install [R](https://www.r-project.org/)
2.  Install [RTools](https://cran.r-project.org/) if you are on Windows
3.  Install [RStudio](https://posit.co/download/rstudio-desktop/)

For more details, see [Software and Package Versions](#software-and-package-versions).

# Running This Code

1.  Ensure the installation steps above are completed
2.  Download a zip of the code and data [here](https://github.com/rrwen/recovr-eval/archive/refs/heads/main.zip) and unzip it
    - Code Repository: [github.com/rrwen/recovr-eval](https://github.com/rrwen/recovr-eval)
3.  In RStudio, open the [src/src.Rproj](https://github.com/rrwen/recovr-eval/blob/main/src/src.Rproj) file
4.  Then, open the [src/index.Rmd](https://github.com/rrwen/recovr-eval/blob/main/src/index.Rmd) file
5.  In RStudio:
    - Run all code: Click the `Run` drop down (top right of the code pane) and click `Run All`
    - Generate HTML version: Click `knit` (top left of code pane) and a file will be generated in `docs/index.html`

# Libraries

Install R packages if needed.

```{r, results = FALSE}

# Required packages
required_packages <- c(
	"rmarkdown",
	"bookdown",
	"knitr",
	"tidyverse",
	"purrr",
	"glue",
	"lubridate",
	"scales",
	"patchwork",
	"DiagrammeR",
	"DiagrammeRsvg",
	"webshot2",
	"magick",
	"rsvg",
	"sf",
	"tmap",
	"ggspatial",
	"prettymapr",
	"units"
)

# Try to install packages if not installed
default_options <- options()
tryCatch(
	{
		# Disable interactivity
		options(install.packages.compile.from.source = "always")
		
		# Install package if not installed
		for (package in required_packages) {
			is_package_installed <- require(package, character.only = TRUE)
			if (!is_package_installed) {
				cat(paste0("Installing package: ", package, "\n"))
				install.packages(package)
			} else {
				cat(paste0("Package already installed: ", package, "\n"))
			}
		}
	},
	error = function(cond) {
		stop(cond)
	},
	finally = {
		options(default_options) # reset interactivity
	}
)
```

Load R libraries.

```{r}
library(DiagrammeR)
library(ggplot2)
library(ggspatial)
library(glue)
library(lubridate)
library(patchwork)
library(sf)
library(tidyverse)
library(tmap)
```

# Data

Read data from the `data` folder.

```{r}
ddesc <- read_csv("../data/data.csv")
ddesc
```

## Vancouver Bikeways {.tabset}

`r ddesc %>% filter(file == "vancouver-bikeways-2024-06-02.geojson") %>% pull(description)`

* **Download Link**: `r ddesc %>% filter(file == "vancouver-bikeways-2024-06-02.geojson") %>% pull(url)`
* **Download Date**: `r format(ddesc %>% filter(file == "vancouver-bikeways-2024-06-02.geojson") %>% pull(download_date), '%B %d, %Y')`
* **Data Updated**: `r format(ddesc %>% filter(file == "vancouver-bikeways-2024-06-02.geojson") %>% pull(update_date), '%B %d, %Y')`
* **Notes**: `r ddesc %>% filter(file == "vancouver-bikeways-2024-06-02.geojson") %>% pull(notes)`

```{r}

# Read data
vancbike_raw <- read_sf("../data/vancouver-bikeways-2024-06-02.geojson")

# Get download date
vancbike_dldate <- ddesc %>% filter(
	file == "vancouver-bikeways-2024-06-02.geojson"
) %>% pull(download_date)
```

### Map

Only the first 1000 records are shown.

```{r}
tmap_mode("view")
tm_shape(vancbike_raw %>% head(1000)) +
    tm_lines(
    	col = "#336699",
    	border.col = "white",
    	popup.vars = TRUE
    )
```

### Data

* Columns: `r ncol(vancbike_raw)`
* Rows: `r nrow(vancbike_raw)`

```{r}
vancbike_raw %>% as_tibble
```

### Dictionary

The data contains the following columns:

```{r, cols.print = 3}
vancbike_ddict <- read_csv("../data/vancouver-bikeways-2024-06-02-datadict.csv")
vancbike_ddict
```

### Details

```{r}
print(vancbike_raw)
```

### Files

The data files are available below:

- [vancouver-bikeways-2024-06-02.geojson](https://github.com/rrwen/recovr-eval/blob/main/data/vancouver-bikeways-2024-06-02.geojson)
- [vancouver-bikeways-2024-06-02-datadict.csv](https://github.com/rrwen/recovr-eval/blob/main/data/vancouver-bikeways-2024-06-02-datadict.csv)

## Calgary Bikeways {.tabset}

`r ddesc %>% filter(file == "calgary-bikeways-2024-06-05.geojson") %>% pull(description)`

* **Download Link**: `r ddesc %>% filter(file == "calgary-bikeways-2024-06-05.geojson") %>% pull(url)`
* **Download Date**: `r format(ddesc %>% filter(file == "calgary-bikeways-2024-06-05.geojson") %>% pull(download_date), '%B %d, %Y')`
* **Data Updated**: `r format(ddesc %>% filter(file == "calgary-bikeways-2024-06-05.geojson") %>% pull(update_date), '%B %d, %Y')`
* **Notes**: `r ddesc %>% filter(file == "calgary-bikeways-2024-06-05.geojson") %>% pull(notes)`

```{r}

# Read data
calgbike_raw <- read_sf("../data/calgary-bikeways-2024-06-05.geojson")

# Get download date
calgbike_dldate <- ddesc %>% filter(
	file == "calgary-bikeways-2024-06-05.geojson"
) %>% pull(download_date)
```

### Map

Only the first 1000 records are shown.

```{r}
tmap_mode("view")
tm_shape(calgbike_raw %>% head(1000)) +
    tm_lines(
    	col = "#336699",
    	border.col = "white",
    	popup.vars = TRUE
    )
```

### Data

* Columns: `r ncol(calgbike_raw)`
* Rows: `r nrow(calgbike_raw)`

```{r}
calgbike_raw %>% as_tibble
```

### Dictionary

The data contains the following columns:

```{r, cols.print = 3}
calgbike_ddict <- read_csv("../data/calgary-bikeways-2024-06-05-datadict.csv")
calgbike_ddict
```

### Details

```{r}
print(calgbike_raw)
```

### Files

The data files are available below:

- [calgary-bikeways-2024-06-05.geojson](https://github.com/rrwen/recovr-eval/blob/main/data/calgary-bikeways-2024-06-05.geojson)
- [calgary-bikeways-2024-06-05-datadict.csv](https://github.com/rrwen/recovr-eval/blob/main/data/calgary-bikeways-2024-06-05-datadict.csv)

## Toronto Bikeways {.tabset}

`r ddesc %>% filter(file == "toronto-bikeways-2024-06-02.geojson") %>% pull(description)`

* **Download Link**: `r ddesc %>% filter(file == "toronto-bikeways-2024-06-02.geojson") %>% pull(url)`
* **Download Date**: `r format(ddesc %>% filter(file == "toronto-bikeways-2024-06-02.geojson") %>% pull(download_date), '%B %d, %Y')`
* **Data Updated**: `r format(ddesc %>% filter(file == "toronto-bikeways-2024-06-02.geojson") %>% pull(update_date), '%B %d, %Y')`
* **Notes**: `r ddesc %>% filter(file == "toronto-bikeways-2024-06-02.geojson") %>% pull(notes)`

```{r}

# Read data
toronbike_raw <- read_sf("../data/toronto-bikeways-2024-06-02.geojson")

# Get download date
toronbike_dldate <- ddesc %>% filter(
	file == "toronto-bikeways-2024-06-02.geojson"
) %>% pull(download_date)
```

### Map

Only the first 1000 records are shown.

```{r}
tmap_mode("view")
tm_shape(toronbike_raw %>% head(1000)) +
    tm_lines(
    	col = "#336699",
    	border.col = "white",
    	popup.vars = TRUE
    )
```

### Data

* Columns: `r ncol(toronbike_raw)`
* Rows: `r nrow(toronbike_raw)`

```{r}
toronbike_raw %>% as_tibble
```

### Dictionary

The data contains the following columns:

```{r, cols.print = 3}
toronbike_ddict <- read_csv("../data/toronto-bikeways-2024-06-02-datadict.csv")
toronbike_ddict
```

### Details

```{r}
print(toronbike_raw)
```

### Files

The data files are available below:

- [toronto-bikeways-2024-06-02.geojson](https://github.com/rrwen/recovr-eval/blob/main/data/toronto-bikeways-2024-06-02.geojson)
- [toronto-bikeways-2024-06-02-datadict.csv](https://github.com/rrwen/recovr-eval/blob/main/data/toronto-bikeways-2024-06-02-datadict.csv)

## Verified Dates {.tabset}

`r ddesc %>% filter(file == "verify-dates-2024-06-12.csv") %>% pull(description)`

* **Download Link**: `r ddesc %>% filter(file == "verify-dates-2024-06-12.csv") %>% pull(url)`
* **Download Date**: `r format(ddesc %>% filter(file == "verify-dates-2024-06-12.csv") %>% pull(download_date), '%B %d, %Y')`
* **Data Updated**: `r format(ddesc %>% filter(file == "verify-dates-2024-06-12.csv") %>% pull(update_date), '%B %d, %Y')`
* **Notes**: `r ddesc %>% filter(file == "verify-dates-2024-06-12.csv") %>% pull(notes)`

```{r}

# Read data
vdates_raw <- read_csv("../data/verify-dates-2024-06-12.csv")

# Get download date
vdates_dldate <- ddesc %>% filter(
	file == "verify-dates-2024-06-12.csv"
) %>% pull(download_date)
```

### Data

* Columns: `r ncol(vdates_raw)`
* Rows: `r nrow(vdates_raw)`

```{r}
vdates_raw
```

### Dictionary

The data contains the following columns:

```{r, cols.print = 3}
vdates_ddict <- read_csv("../data/verify-dates-2024-06-12-datadict.csv")
vdates_ddict
```

### Files

The data files are available below:

- [verify-dates-2024-06-12.csv](https://github.com/rrwen/recovr-eval/blob/main/data/verify-dates-2024-06-12.csv)
- [verify-dates-2024-06-12-datadict.csv](https://github.com/rrwen/recovr-eval/blob/main/data/verify-dates-2024-06-12-datadict.csv)

## Toronto KSI {.tabset}

`r ddesc %>% filter(file == "toronto-ksi-2024-06-13.csv") %>% pull(description)`

* **Download Link**: `r ddesc %>% filter(file == "toronto-ksi-2024-06-13.csv") %>% pull(url)`
* **Download Date**: `r format(ddesc %>% filter(file == "toronto-ksi-2024-06-13.csv") %>% pull(download_date), '%B %d, %Y')`
* **Data Updated**: `r format(ddesc %>% filter(file == "toronto-ksi-2024-06-13.csv") %>% pull(update_date), '%B %d, %Y')`
* **Notes**: `r ddesc %>% filter(file == "toronto-ksi-2024-06-13.csv") %>% pull(notes)`

```{r}

# Read data
ksi_raw <- read_sf(
	"../data/toronto-ksi-2024-06-13.csv",
	options = c(
		"X_POSSIBLE_NAMES=LONGITUDE",
		"Y_POSSIBLE_NAMES=LATITUDE"
	),
	crs = 4326
)

# Get download date
ksi_dldate <- ddesc %>% filter(
	file == "toronto-ksi-2024-06-13.csv"
) %>% pull(download_date)
```

### Map

**Note**: Due to the large number of records, only the latest year of `r year(max(ksi_raw$DATE))` is displayed (n = `r ksi_raw %>% filter(year(DATE) == max(year(DATE))) %>% nrow`).

```{r}
tmap_mode("view")
tm_shape(ksi_raw %>% filter(year(DATE) == max(year(DATE)))) +
    tm_dots(
    	col = "ACCLASS",
    	clustering = TRUE,
    	popup.vars = TRUE
    )
```

### Data

* Columns: `r ncol(ksi_raw)`
* Rows: `r nrow(ksi_raw)`

```{r}
ksi_raw %>% as_tibble()
```

### Dictionary

The data contains the following columns:

```{r, cols.print = 3}
ksi_ddict <- read_csv("../data/toronto-ksi-2024-06-13-datadict.csv")
ksi_ddict
```

### Details

```{r}
print(ksi_raw)
```

### Files

The data files are available below:

- [toronto-ksi-2024-06-13.csv](https://github.com/rrwen/recovr-eval/blob/main/data/toronto-ksi-2024-06-13.csv)
- [toronto-ksi-2024-06-13-datadict.csv](https://github.com/rrwen/recovr-eval/blob/main/data/toronto-ksi-2024-06-13-datadict.csv)

# Cleaning

## Combine Bikeways {.tabset}

Combine bikeway data across all cities.

```{r}

# List of city bikeway data
bike_list <- list(
	vancouver = vancbike_raw,
	calgary = calgbike_raw %>%
		mutate(no_verify_install_type = NA),
	toronto = toronbike_raw %>%
		mutate(no_verify_install_type = NA)
)

# Get common columns across all city bikeways
bike_cols <- bike_list %>%
	map(colnames) %>%
	reduce(intersect)

# Combine bikeway data across cities
bike_raw <- names(bike_list) %>%
	map(function(city) {
		bike_list[[city]] %>%
			select(
				all_of(bike_cols)
			) %>%
			mutate(
				city = factor(city, levels = names(bike_list)),
				.before = 1
			)
	}) %>%
	reduce(add_row)

# Display combined bikeway data
bike_raw %>% as_tibble

```

## Pivot Long Format

Pivot bikeways data to long format, where each record represents an installation or upgrade.

Also adds the following columns:

* `_pivot_type`: one of `install`, `upgrade1`, or `upgrade2`
* `_pivot_year`: the year of the install or upgrade from `verify_install_year`, `verify_upgrade1_year`, or `verify_upgrade2_year`

```{r}

# Pivot to long format on installs and upgrades
bike <- bike_raw %>%
    pivot_longer(
        cols = c(
            verify_install_date,
            verify_upgrade1_date,
            verify_upgrade2_date
        ),
        names_to = "_pivot_column",
        values_to = "_pivot_value"
    ) %>%
	mutate(
		`_pivot_type` = case_when(
			str_starts(`_pivot_column`, "verify_install") ~ "install",
			str_starts(`_pivot_column`, "verify_upgrade1") ~ "upgrade1",
			str_starts(`_pivot_column`, "verify_upgrade2") ~ "upgrade2"
		),
		`_pivot_year` = case_when(
			`_pivot_type` == "install" ~ verify_install_year,
			`_pivot_type` == "upgrade1" ~ verify_upgrade1_year,
			`_pivot_type` == "upgrade2" ~ verify_upgrade2_year
		)
	)

# Display pivot columns
bike %>%
	as_tibble %>%
	select(
		`_pivot_type`,
		`_pivot_year`,
		`_pivot_column`,
		`_pivot_value`,
		everything()
	) %>%
	arrange(`_pivot_year`)

```

## Add Clean Dates

Join ambiguous verified install/upgrade dates (e.g. Jan 1/2022, 2022/02, Fall 2020) to manually cleaned dates with structured time units (e.g. days, months, quarters, semesters, ranges) and date formats (e.g. 2022-01-01, 2022-02-01).

The following cleaned structured date columns will be added to bikeways:

`r paste0("\n * ", colnames(vdates_raw) %>% .[. != "verify_date_raw"], collapse = "")`

```{r}

# Join clean dates to include structured date formats
bike <- bike %>%
	left_join(
		vdates_raw,
		by = join_by(`_pivot_value` == verify_date_raw)
	)

# Display clean dates cols
bike %>%
	as_tibble %>%
	select(all_of(
		colnames(vdates_raw) %>%
			.[. != "verify_date_raw"]
	)) %>%
	arrange(verify_date_type)

```

## Add Time Units {.tabset}

Add the following time unit columns for installs/upgrades in bikeways and ksi:

* `_time_month`: which month (1, 2, 3 ... 12) a bikeway had a verified installation/upgrade
* `_time_quarter`: which quarter (1, 2, 3, 4) of the year a bikeway had a verified installation/upgrade
* `_time_third`: which third (1, 2, 3) of the year a bikeway had a verified installation/upgrade
* `_time_half`: which half (1, 2) of the year a bikeway had a verified installation/upgrade
* `_time_semester`: which semester (1, 2) of the year a bikeway had a verified installation/upgrade, where:
	* `1`: represents November to April of next year
	* `2`: represents May to October of next year

**Note**: Date ranges that fall between months, quarters, thirds, or halves of the year were excluded from being classified as any of the time units (e.g. March 31 to April 15 will be excluded as it does not fall within either the 1st or 2nd quarter of the year).

```{r}

#' Add Time Units to Data Frame
#'
#' This function takes a data frame and adds new columns representing various time units such as month, quarter, third, half, and semester. These columns are derived from a date column or if the time unit is more than day, then additiona start and end date columns
#'
#' @param df A data frame that contains the columns `verify_date`, `verify_date_type`, `verify_date_start`, and `verify_date_end`.
#' @param date_col Name of the date column to use
#' @param start_col Name of the start date column to use
#' @param end_col Name of the end date column to use
#' @param type_col Name of the date type column to use (e.g. month, day, year, etc)
#'
#' @return A data frame with additional columns:
#' \describe{
#'   \item{`_time_month`}{Numeric representation of the month (1-12).}
#'   \item{`_time_quarter`}{Quarter of the year (1-4).}
#'   \item{`_time_third`}{Third of the year (1-3).}
#'   \item{`_time_half`}{Half of the year (1-2).}
#'   \item{`_time_semester`}{Custom semester (1 for May-Oct, 2 for Nov-Apr).}
#' }
#'
#' @examples
#' \dontrun{
#' df <- data.frame(
#'   verify_date = as.Date(c("2021-01-15", "2021-06-20", "2021-09-10")),
#'   verify_date_type = c("day", "month", "day"),
#'   verify_date_start = as.Date(c("2021-01-01", "2021-06-01", "2021-09-01")),
#'   verify_date_end = as.Date(c("2021-01-31", "2021-06-30", "2021-09-30"))
#' )
#' result <- add_time_units(df)
#' print(result)
#' }
#'
#' @import dplyr
#' @importFrom lubridate month year
#' @export
add_time_units <- function(
	df,
	date_col = "verify_date",
	start_col = "verify_date_start",
	end_col = "verify_date_end",
	type_col = "verify_date_type"
) {
	df %>%
		rename( # rename req cols
			`_date` := !!sym(date_col),
			`_start` := !!sym(start_col),
			`_end` := !!sym(end_col),
			`_type` := !!sym(type_col)
		) %>%
		mutate( # add time units
			
			# Months (monthly)
			`_time_month` = case_when(
				`_type` %in% c("day", "month") ~ month(`_date`, label = T, abbr = F)
			),
			`_time_month` = as.numeric(`_time_month`),
			
			# Quarters (quarterly)
			`_time_quarter` = case_when(
				month(`_date`) %in% 1:3 |
				(
					month(`_start`) %in% 1:3 &
					month(`_end`) %in% 1:3 &
					year(`_start`) == year(`_end`)
				) ~ 1,
				month(`_date`) %in% 4:6 |
				(
					month(`_start`) %in% 4:6 &
					month(`_end`) %in% 4:6 &
					year(`_start`) == year(`_end`)
				) ~ 2,
				month(`_date`) %in% 7:9 |
				(
					month(`_start`) %in% 7:9 &
					month(`_end`) %in% 7:9 &
					year(`_start`) == year(`_end`)
				) ~ 3,
				month(`_date`) %in% 10:12 |
				(
					month(`_start`) %in% 10:12 &
					month(`_end`) %in% 10:12 &
					year(`_start`) == year(`_end`)
				) ~ 4
			),
			
			# Thirds (triyearly)
			`_time_third` = case_when(
				month(`_date`) %in% 1:4 |
				(
					month(`_start`) %in% 1:4 &
					month(`_end`) %in% 1:4 &
					year(`_start`) == year(`_end`)
				) ~ 1, # Fall
				month(`_date`) %in% 5:8 |
				(
					month(`_start`) %in% 5:8 &
					month(`_end`) %in% 5:8 &
					year(`_start`) == year(`_end`)
				) ~ 2, # Winter
				month(`_date`) %in% 9:12 |
				(
					month(`_start`) %in% 9:12 &
					month(`_end`) %in% 9:12 &
					year(`_start`) == year(`_end`)
				) ~ 3 # Spring/Summer
			),
			
			# Halves (biyearly)
			`_time_half` = case_when(
				month(`_date`) %in% 1:6 |
				(
					month(`_start`) %in% 1:6 &
					month(`_end`) %in% 1:6 &
					year(`_start`) == year(`_end`)
				) ~ 1,
				month(`_date`) %in% 7:12 |
				(
					month(`_start`) %in% 7:12 &
					month(`_end`) %in% 7:12 &
					year(`_start`) == year(`_end`)
				) ~ 2
			),
			
			# Semester (custom range)
			`_time_semester` = case_when(
				month(`_date`) %in% c(11:12, 1:4) |
				(
					month(`_start`) %in% c(11:12, 1:4) &
					( # Nov to Dec of this year
						month(`_end`) %in% 11:12 &
						year(`_end`) == year(`_start`)
					) |
					( # Jan to Apr of this or next year
						month(`_end`) %in% 1:4 &
						year(`_end`) == year(`_start`) |
						year(`_end`) == (year(`_start`) + 1)
					)
				) ~ 2, # Nov to Apr of next year
				month(`_date`) %in% 5:10 |
				(
					month(`_start`) %in% 5:10 &
					month(`_end`) %in% 5:10 &
					year(`_start`) == year(`_end`)
				) ~ 1 # May to Oct
			)
		) %>%
		rename( # rename back to orig
			!!date_col := `_date`,
			!!start_col := `_start`,
			!!end_col := `_end`,
			!!type_col := `_type`
		)
}

# Add time unit columns using func for bikeways
bike <- bike %>% add_time_units

# Add time unit columns using func for ksi
ksi <- ksi_raw %>%
	mutate( # add cols to standardize func params
		verify_date = format(DATE, "%Y-%m-%d"),
		verify_date_start = NA,
		verify_date_end = NA,
		verify_date_type = "day"
	) %>%
	add_time_units %>%
	select( # remove no longer needed cols
		-verify_date,
		-verify_date_start,
		-verify_date_end,
		-verify_date_type
	)

```

### Bikeways

```{r}

# Display time unit cols for bikeways
bike %>%
	as_tibble %>%
	select(
		verify_date_type,
		verify_date,
		verify_date_start,
		verify_date_end,
		starts_with("_")
	) %>%
	arrange(`_pivot_value`)

```

### KSI

```{r}

# Display time unit cols for ksi
ksi %>%
	as_tibble %>%
	select(
		DATE,
		starts_with("_")
	) %>%
	arrange(year(DATE))

```

## Filter Verified Post-2011 {.tabset}

Filter for bikeways and KSI with a verified installation or upgrade after 2011.

```{r}

# Filter bikeways for post2011
bike <- bike %>%
	filter(`_pivot_year` > 2011)

# Filter ksi for post2011
ksi <- ksi %>%
	filter(year(DATE) > 2011)

```

### Bikeways

```{r}

# Display filtered rows
bike %>%
	as_tibble %>%
	select(
		`_pivot_year`,
		`_pivot_type`,
		verify_install_year,
		verify_upgrade1_year,
		verify_upgrade2_year
	) %>%
	arrange(`_pivot_year`)

```

### KSI

```{r}

# Display filtered rows
ksi %>%
	as_tibble %>%
	select(DATE) %>%
	arrange(year(DATE))

```

## Determine Unit of Time

For bikeways, determine the temporal resolution (unit of time) finer than yearly based on the amount of data available per time unit (sorted from the highest resolution time unit to the lowest resolution time unit):

* **Month** (high): refers to verified post-2011 installs and upgrades occurring approximately in a month (1/12) of a year
* **Quarter**: refers to verified post-2011 installs and upgrades occurring approximately in a quarter (1/4) of a year
* **Third**: refers to verified post-2011 installs and upgrades occurring approximately in a third (1/3) of a year
* **Half** (low): refers to verified post-2011 installs and upgrades occurring approximately in a half (1/2) of a year
* **Semester** (low): refers to verified post-2011 installs and upgrades occurring approximately in a half (1/2) of a year with the first half (1) being November (same year) to April (next year) and the second half being May to October (next year)

As there seems to be a large improvement in the percentage of records across cities from quarters to thirds of a year, and diminishing improvements when lowering the resolution to halves of a year, thirds of a year was chosen as the unit of time.

```{r}

# Prepare plot data
unit_data <- bike %>%
	as_tibble %>%
	group_by(city) %>%
	summarize( # calc installs/upgrades for each time unit
		Month = sum(!is.na(`_time_month`)),
		Quarter = sum(!is.na(`_time_quarter`)),
		Third = sum(!is.na(`_time_third`)),
		Half = sum(!is.na(`_time_half`)),
		Semester = sum(!is.na(`_time_semester`))
	) %>%
	pivot_longer(
		cols = -city,
		names_to = "type",
		values_to = "n"
	) %>%
	mutate( # zero as NA
		n = if_else(n == 0, NA, n)
	) %>%
	left_join( # Add city totals
		bike %>%
			as_tibble %>%
			group_by(city) %>%
			count(name = "total"),
		by = "city"
	) %>%
	ungroup %>%
    mutate( # calc percentages and add labels
        type = factor(type, levels = c("Month", "Quarter", "Third", "Half", "Semester")),
        city = factor(str_to_title(city), levels = c("Vancouver", "Calgary", "Toronto")),
        perc = n / total * 100,
        perc_label = glue(
        	"{str_sub(city, end = 1)}: {round(perc, 2)}%\n",
        	"(n={format(n, big.mark = ',', scientific = F)})"
        )
    ) %>%
    group_by(type) %>% # adjust overlapping labels
    arrange(desc(perc)) %>% 
    mutate( # detect overlap labels and shift down and up
        perc_label_y = case_when(
            lag(perc) - perc < 2 ~ perc - 1.5,
            lead(perc) - perc > -2 ~ perc + 1.5,
            .default = perc
        )
    ) %>%
	group_by(city) %>%
	mutate( # add city labels at end of lines
		city_label = if_else(
			type == "Semester",
			glue(
				"{city}\n",
				"(n={format(total, big.mark = ',', scientific = F)})"
			),
			NA
		)
	) %>%
	ungroup %>%
    arrange(city, type)

# Get total
unit_total <- sum(unit_data$total %>% unique, na.rm = T)
unit_total_label <- format(unit_total, big.mark = ",", scientific = F)

# Plot line
unit_plot <- unit_data %>%
	ggplot(aes(
		x = type,
		y = perc,
		group = city,
		color = city,
		label = perc_label
	)) +
	geom_line(
		alpha = 0.8,
		linewidth = 1.5
	) +
	geom_label(
		aes(y = perc_label_y),
		size = 2,
		show.legend = F,
		label.padding = unit(0.5, "lines")
	) +
	geom_text(
		aes(
			label = city_label,
			y = perc_label_y
		),
		size = 2.25,
		show.legend = F,
		hjust = 0,
		nudge_x = 0.25
	) +
	scale_y_continuous(labels = function(x) paste0(x, "%")) +
	scale_x_discrete(
		limits = levels(unit_data$type),
		position = "top"
	) +
	labs(
		title = glue(
			"% of Verified Post-2011 Installs & Upgrades by Unit of Time\n",
			"(n={unit_total_label})"
		),
		x = NULL,
		y = NULL,
		color = "City",
		label = NULL,
		group = NULL
	) +
	theme_minimal() +
	theme(
		legend.position = "none",
		plot.title = element_text(hjust = 0.5)
	)
unit_plot

# Select time unit
tunit = "third"
```

## Add Spatiotemporal Groups {.tabset}

Add a column `_time_group` that stores the spatiotemporal grouping for both the ksi and bikeways.

```{r}

# Assign spatiotemp group for bikeways
bike <- bike %>% mutate(
	`_time_group` = glue("Third {`_time_third`} {`_pivot_year`}")
)

# Assign spatiotemp group for ksi
ksi <- ksi %>% mutate(
	`_time_group` = glue("Third {`_time_third`} {year(DATE)}")
)

```

### Bikeways

```{r}

# Display spatiotemp groups for bikeways
bike %>%
	as_tibble %>%
	select(
		`_time_third`,
		`_pivot_year`,
		`_time_group`
	) %>%
	arrange(`_pivot_year`)

```

### KSI

```{r}

# Display spatiotemp groups for ksi
ksi %>%
	as_tibble %>%
	select(
		`_time_third`,
		DATE,
		`_time_group`
	) %>%
	arrange(year(DATE))

```

## Join Bikeways and KSI

Spatiotemporally join KSI to nearest bikeways based on the spatiotemporal groups.

Each KSI point is joined to a bikeway if they are:

* **Spatially Related**: is the nearest point within 25 meters of the bikeway
* **Temporally Related**: has the same year and spatiotemporal group

**Note**: if there is overlapping of bikeways, the same KSI can be assigned to multiple bikeways.

```{r}

# Set cache file for spatiotemp join
bike_nid_file <- glue("../data/cache/bike-nid-{ksi_dldate}.csv")

# Spatial join ksi by spatiotemp group
if (!file.exists(bike_nid_file)) {
	
	# Run spatial join if no up to date cache
	bike_nid <- bike %>%
		arrange(`_time_group`) %>%
		group_by(`_time_group`) %>%
		group_map(~ {
			
			# Temporal filter by group
			ksi_temp <- ksi %>%
				filter(`_time_group` == .y$`_time_group`)
			
			# Buffer 25 meters
			bike_buff <- .x %>% buffer(25)
			
			# Spatial join
			.x %>%
				st_join(bike_temp) %>%
				select(
					city,
					id,
					INDEX_
				) %>%
				as_tibble %>%
				select(-geometry)
			
		}, .keep = T) %>%
		reduce(bind_rows)
	
	# Cache spatiotemp join
	bike_nid %>% write_csv(bike_nid_file)

} else {
	
	# Read spatiotemp join from cache
	bike_nid <- read_csv(bike_nid_file)

}
```
