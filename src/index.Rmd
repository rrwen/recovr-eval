---
title: "Cycling Interventions Evaluation"
subtitle: "R Code"
author:
- "Richard Wen richard.wen@utoronto.ca"
- "Brice Batomen brice.kuimi@utoronto.ca"
- "Linda Rothman linda.rothman@torontomu.ca"
- "Andrew Howard andrew.howard@sickkids.ca"
date: "`r format(Sys.time(), '%B %d, %Y')`"
knit: |
    (function(input_rmd, ...) {
    rmarkdown::render(
        input_rmd,
        rmarkdown::html_document(
            toc = TRUE,
            toc_float = TRUE,
            highlight = "zenburn",
            code_folding = "hide",
            df_print = "paged",
            self_contained = FALSE
        ),
        output_dir = "../docs",
        output_file = "index", ...)
    })
---

```{r include = FALSE, echo = FALSE}
knitr::opts_chunk$set(
	warning = FALSE,
	message = FALSE
)
```

# Installation

1.  Install [R](https://www.r-project.org/)
2.  Install [RTools](https://cran.r-project.org/) if you are on Windows
3.  Install [RStudio](https://posit.co/download/rstudio-desktop/)

For more details, see [Software and Package Versions](#software-and-package-versions).

# Running This Code

1.  Ensure the installation steps above are completed
2.  Download a zip of the code and data [here](https://github.com/rrwen/recovr-eval/archive/refs/heads/main.zip) and unzip it
    - Code Repository: [github.com/rrwen/recovr-eval](https://github.com/rrwen/recovr-eval)
3.  In RStudio, open the [src/src.Rproj](https://github.com/rrwen/recovr-eval/blob/main/src/src.Rproj) file
4.  Then, open the [src/index.Rmd](https://github.com/rrwen/recovr-eval/blob/main/src/index.Rmd) file
5.  In RStudio:
    - Run all code: Click the `Run` drop down (top right of the code pane) and click `Run All`
    - Generate HTML version: Click `knit` (top left of code pane) and a file will be generated in `docs/index.html`

# Libraries

Install R packages if needed.

```{r, results = FALSE}

# Required packages
required_packages <- c(
	"rmarkdown",
	"bookdown",
	"knitr",
	"tidyverse",
	"purrr",
	"glue",
	"lubridate",
	"scales",
	"patchwork",
	"DiagrammeR",
	"DiagrammeRsvg",
	"webshot2",
	"magick",
	"rsvg",
	"sf",
	"tmap",
	"ggspatial",
	"prettymapr",
	"units",
	"boot"
)

# Try to install packages if not installed
default_options <- options()
tryCatch(
	{
		# Disable interactivity
		options(install.packages.compile.from.source = "always")
		
		# Install package if not installed
		for (package in required_packages) {
			is_package_installed <- require(package, character.only = TRUE)
			if (!is_package_installed) {
				cat(paste0("Installing package: ", package, "\n"))
				install.packages(package)
			} else {
				cat(paste0("Package already installed: ", package, "\n"))
			}
		}
	},
	error = function(cond) {
		stop(cond)
	},
	finally = {
		options(default_options) # reset interactivity
	}
)
```

Load R libraries.

```{r}
library(boot)
library(DiagrammeR)
library(ggplot2)
library(ggspatial)
library(glue)
library(lubridate)
library(patchwork)
library(sf)
library(tidyverse)
library(tmap)
```

# Data

Read data from the `data` folder.

```{r}
ddesc <- read_csv("../data/data.csv")
ddesc
```

## Vancouver Bikeways {.tabset}

`r ddesc %>% filter(file == "vancouver-bikeways-2024-06-02.geojson") %>% pull(description)`

* **Download Link**: `r ddesc %>% filter(file == "vancouver-bikeways-2024-06-02.geojson") %>% pull(url)`
* **Download Date**: `r format(ddesc %>% filter(file == "vancouver-bikeways-2024-06-02.geojson") %>% pull(download_date), '%B %d, %Y')`
* **Data Updated**: `r format(ddesc %>% filter(file == "vancouver-bikeways-2024-06-02.geojson") %>% pull(update_date), '%B %d, %Y')`
* **Notes**: `r ddesc %>% filter(file == "vancouver-bikeways-2024-06-02.geojson") %>% pull(notes)`

```{r}

# Read data
vancbike_raw <- read_sf("../data/vancouver-bikeways-2024-06-02.geojson")

# Get download date
vancbike_dldate <- ddesc %>% filter(
	file == "vancouver-bikeways-2024-06-02.geojson"
) %>% pull(download_date)
```

### Map

Only the first 1000 records are shown.

```{r}
tmap_mode("view")
tm_shape(vancbike_raw %>% head(1000)) +
    tm_lines(
    	col = "#336699",
    	border.col = "white",
    	popup.vars = TRUE
    )
```

### Data

* Columns: `r ncol(vancbike_raw)`
* Rows: `r nrow(vancbike_raw)`

```{r}
vancbike_raw %>% as_tibble
```

### Dictionary

The data contains the following columns:

```{r, cols.print = 3}
#vancbike_ddict <- read_csv("../data/vancouver-bikeways-2024-06-02-datadict.csv")
#vancbike_ddict
```

### Details

```{r}
print(vancbike_raw)
```

### Files

The data files are available below:

- [vancouver-bikeways-2024-06-02.geojson](https://github.com/rrwen/recovr-eval/blob/main/data/vancouver-bikeways-2024-06-02.geojson)
- [vancouver-bikeways-2024-06-02-datadict.csv](https://github.com/rrwen/recovr-eval/blob/main/data/vancouver-bikeways-2024-06-02-datadict.csv)

## Calgary Bikeways {.tabset}

`r ddesc %>% filter(file == "calgary-bikeways-2024-06-05.geojson") %>% pull(description)`

* **Download Link**: `r ddesc %>% filter(file == "calgary-bikeways-2024-06-05.geojson") %>% pull(url)`
* **Download Date**: `r format(ddesc %>% filter(file == "calgary-bikeways-2024-06-05.geojson") %>% pull(download_date), '%B %d, %Y')`
* **Data Updated**: `r format(ddesc %>% filter(file == "calgary-bikeways-2024-06-05.geojson") %>% pull(update_date), '%B %d, %Y')`
* **Notes**: `r ddesc %>% filter(file == "calgary-bikeways-2024-06-05.geojson") %>% pull(notes)`

```{r}

# Read data
calgbike_raw <- read_sf("../data/calgary-bikeways-2024-06-05.geojson")

# Get download date
calgbike_dldate <- ddesc %>% filter(
	file == "calgary-bikeways-2024-06-05.geojson"
) %>% pull(download_date)
```

### Map

Only the first 1000 records are shown.

```{r}
tmap_mode("view")
tm_shape(calgbike_raw %>% head(1000)) +
    tm_lines(
    	col = "#336699",
    	border.col = "white",
    	popup.vars = TRUE
    )
```

### Data

* Columns: `r ncol(calgbike_raw)`
* Rows: `r nrow(calgbike_raw)`

```{r}
calgbike_raw %>% as_tibble
```

### Dictionary

The data contains the following columns:

```{r, cols.print = 3}
#calgbike_ddict <- read_csv("../data/calgary-bikeways-2024-06-05-datadict.csv")
#calgbike_ddict
```

### Details

```{r}
print(calgbike_raw)
```

### Files

The data files are available below:

- [calgary-bikeways-2024-06-05.geojson](https://github.com/rrwen/recovr-eval/blob/main/data/calgary-bikeways-2024-06-05.geojson)
- [calgary-bikeways-2024-06-05-datadict.csv](https://github.com/rrwen/recovr-eval/blob/main/data/calgary-bikeways-2024-06-05-datadict.csv)

## Toronto Bikeways {.tabset}

`r ddesc %>% filter(file == "toronto-bikeways-2024-06-02.geojson") %>% pull(description)`

* **Download Link**: `r ddesc %>% filter(file == "toronto-bikeways-2024-06-02.geojson") %>% pull(url)`
* **Download Date**: `r format(ddesc %>% filter(file == "toronto-bikeways-2024-06-02.geojson") %>% pull(download_date), '%B %d, %Y')`
* **Data Updated**: `r format(ddesc %>% filter(file == "toronto-bikeways-2024-06-02.geojson") %>% pull(update_date), '%B %d, %Y')`
* **Notes**: `r ddesc %>% filter(file == "toronto-bikeways-2024-06-02.geojson") %>% pull(notes)`

```{r}

# Read data
toronbike_raw <- read_sf("../data/toronto-bikeways-2024-06-02.geojson")

# Get download date
toronbike_dldate <- ddesc %>% filter(
	file == "toronto-bikeways-2024-06-02.geojson"
) %>% pull(download_date)
```

### Map

Only the first 1000 records are shown.

```{r}
tmap_mode("view")
tm_shape(toronbike_raw %>% head(1000)) +
    tm_lines(
    	col = "#336699",
    	border.col = "white",
    	popup.vars = TRUE
    )
```

### Data

* Columns: `r ncol(toronbike_raw)`
* Rows: `r nrow(toronbike_raw)`

```{r}
toronbike_raw %>% as_tibble
```

### Dictionary

The data contains the following columns:

```{r, cols.print = 3}
#toronbike_ddict <- read_csv("../data/toronto-bikeways-2024-06-02-datadict.csv")
#toronbike_ddict
```

### Details

```{r}
print(toronbike_raw)
```

### Files

The data files are available below:

- [toronto-bikeways-2024-06-02.geojson](https://github.com/rrwen/recovr-eval/blob/main/data/toronto-bikeways-2024-06-02.geojson)
- [toronto-bikeways-2024-06-02-datadict.csv](https://github.com/rrwen/recovr-eval/blob/main/data/toronto-bikeways-2024-06-02-datadict.csv)

## Verified Dates {.tabset}

`r ddesc %>% filter(file == "verify-dates-2024-06-07.csv") %>% pull(description)`

* **Download Link**: `r ddesc %>% filter(file == "verify-dates-2024-06-07.csv") %>% pull(url)`
* **Download Date**: `r format(ddesc %>% filter(file == "verify-dates-2024-06-07.csv") %>% pull(download_date), '%B %d, %Y')`
* **Data Updated**: `r format(ddesc %>% filter(file == "verify-dates-2024-06-07.csv") %>% pull(update_date), '%B %d, %Y')`
* **Notes**: `r ddesc %>% filter(file == "verify-dates-2024-06-07.csv") %>% pull(notes)`

```{r}

# Read data
vdates_raw <- read_csv("../data/verify-dates-2024-06-07.csv")

# Get download date
vdates_dldate <- ddesc %>% filter(
	file == "verify-dates-2024-06-07.csv"
) %>% pull(download_date)
```

### Data

* Columns: `r ncol(vdates_raw)`
* Rows: `r nrow(vdates_raw)`

```{r}
vdates_raw
```

### Dictionary

The data contains the following columns:

```{r, cols.print = 3}
vdates_ddict <- read_csv("../data/verify-dates-2024-06-07-datadict.csv")
vdates_ddict
```

### Files

The data files are available below:

- [verify-dates-2024-06-07.csv](https://github.com/rrwen/recovr-eval/blob/main/data/verify-dates-2024-06-07.csv)
- [verify-dates-2024-06-07-datadict.csv](https://github.com/rrwen/recovr-eval/blob/main/data/verify-dates-2024-06-07-datadict.csv)

## Toronto KSI {.tabset}

`r ddesc %>% filter(file == "toronto-ksi-2024-06-01.geojson") %>% pull(description)`

* **Download Link**: `r ddesc %>% filter(file == "toronto-ksi-2024-06-01.geojson") %>% pull(url)`
* **Download Date**: `r format(ddesc %>% filter(file == "toronto-ksi-2024-06-01.geojson") %>% pull(download_date), '%B %d, %Y')`
* **Data Updated**: `r format(ddesc %>% filter(file == "toronto-ksi-2024-06-01.geojson") %>% pull(update_date), '%B %d, %Y')`
* **Notes**: `r ddesc %>% filter(file == "toronto-ksi-2024-06-01.geojson") %>% pull(notes)`

```{r}

# Read data
ksi_raw <- read_sf("../data/toronto-ksi-2024-06-01.geojson")

# Get download date
ksi_dldate <- ddesc %>% filter(
	file == "toronto-ksi-2024-06-01.geojson"
) %>% pull(download_date)
```

### Map

**Note**: Due to the large number of records, only the latest year of `r year(max(ksi_raw$DATE))` is displayed (n = `r ksi_raw %>% filter(year(DATE) == max(year(DATE))) %>% nrow`).

```{r}
tmap_mode("view")
tm_shape(ksi_raw %>% filter(year(DATE) == max(year(DATE)))) +
    tm_dots(
    	col = "ACCLASS",
    	clustering = TRUE,
    	popup.vars = TRUE
    )
```

### Data

* Columns: `r ncol(ksi_raw)`
* Rows: `r nrow(ksi_raw)`

```{r}
ksi_raw %>% as_tibble()
```

### Dictionary

The data contains the following columns:

```{r, cols.print = 3}
ksi_ddict <- read_csv("../data/toronto-ksi-2024-06-01-datadict.csv")
ksi_ddict
```

### Details

```{r}
print(ksi_raw)
```

### Files

The data files are available below:

- [toronto-ksi-2024-06-01.geojson](https://github.com/rrwen/recovr-eval/blob/main/data/toronto-ksi-2024-06-01.geojson)
- [toronto-ksi-2024-06-01-datadict.csv](https://github.com/rrwen/recovr-eval/blob/main/data/toronto-ksi-2024-06-01-datadict.csv)

# Cleaning

## Combine Bikeways {.tabset}

Combine bikeway data across all cities.

```{r}

# List of city bikeway data
bike_list <- list(
	vancouver = vancbike_raw,
	calgary = calgbike_raw %>%
		mutate(no_verify_install_type = NA),
	toronto = toronbike_raw %>%
		mutate(no_verify_install_type = NA)
)

# Get common columns across all city bikeways
bike_cols <- bike_list %>%
	map(colnames) %>%
	reduce(intersect)

# Combine bikeway data across cities
bike_raw <- names(bike_list) %>%
	map(function(city) {
		bike_list[[city]] %>%
			select(
				all_of(bike_cols)
			) %>%
			mutate(
				city = factor(city, levels = names(bike_list)),
				.before = 1
			)
	}) %>%
	reduce(add_row)
```

## Join Clean Dates

Join ambiguous verified install/upgrade dates (e.g. Jan 1/2022, 2022/02, Fall 2020) to manually cleaned dates with structured time units (e.g. days, months, quarters, semesters, ranges) and date formats (e.g. 2022-01-01, 2022-02-01).

Each of `verify_install_date`, `verify_upgrade1_date` and `verify_upgrade2_date` will have a set of cleaned structured date columns:

`r paste0("\n * ", colnames(vdates_raw))`

```{r}

# Join clean dates to include structured date formats
for (event in c("install", "upgrade1", "upgrade2")) {
	
	# Date col names
	date_col <- glue("verify_{event}_date")
	clean_col <- glue("{event}_verify_date_raw")
	
	# Join clean dates
	bike_raw <- bike_raw %>%
		left_join( # join to installs
			vdates_raw %>%
				rename_with(
					~ paste0(event, "_", .x),
					everything()
				),
			by = set_names(clean_col, date_col)
		)
}

```

## Add Columns

Add the following filter columns:

* `_is_verify`: if a bikeway had a verified installation or upgrade
* `_is_verify_post2018`: if a bikeway had a verified installation or upgrade after 2018
* `_is_verify_dated`: if a bikeway had a verified installation or upgrade with dates
* `_is_verify_cdated`: if a bikeway had a verified installation or upgrade with cleaned dates

Then add the following finest time unit columns for installs/upgrades:

* `install_verify_date_month`: which month (1, 2, 3 ... 12) a bikeway had verified installation
* `install_verify_date_quarter`: which quarter (1, 2, 3, 4) of the year a bikeway had verified installation
* `install_verify_date_third`: which third (1, 2, 3) of the year a bikeway had verified installation
* `install_verify_date_half`: which half (1, 2) of the year a bikeway had verified installation
* `upgrade1_verify_date_month`: which month (1, 2, 3 ... 12) a bikeway had verified 1st upgrade
* `upgrade1_verify_date_quarter`: which quarter (1, 2, 3, 4) of the year a bikeway had verified 1st upgrade
* `upgrade1_verify_date_third`: which third (1, 2, 3) of the year a bikeway had verified 1st upgrade
* `upgrade1_verify_date_half`: which half (1, 2) of the year a bikeway had verified 1st upgrade
* `upgrade2_verify_date_month`: which month (1, 2, 3 ... 12) a bikeway had verified 2nd upgrade
* `upgrade2_verify_date_quarter`: which quarter (1, 2, 3, 4) of the year a bikeway had verified 2nd upgrade
* `upgrade2_verify_date_third`: which third (1, 2, 3) of the year a bikeway had verified 2nd upgrade
* `upgrade2_verify_date_half`: which half (1, 2) of the year a bikeway had verified 2nd upgrade

```{r}

# Add filter columns
bike_raw <- bike_raw %>%
	mutate(
		`_is_verify` =
			(!is.na(verify_install_year) |
			 !is.na(verify_upgrade1_year) |
			 !is.na(verify_upgrade2_year)) &
			is.na(no_verify_install_type),
		`_is_verify_post2018` = 
			verify_install_year > 2018 |
			verify_upgrade1_year > 2018 |
			verify_upgrade2_year > 2018,
		`is_verify_dated` =
			!is.na(verify_install_date) |
			!is.na(verify_upgrade2_date) |
			!is.na(verify_upgrade2_date),
		`is_verify_cdated` = 
			!is.na(install_verify_date_type) |
			!is.na(upgrade1_verify_date_type) |
			!is.na(upgrade2_verify_date_type)
	)

# Add time unit columns for month, quarter, third, half
for (event in c("install", "upgrade1", "upgrade2")) {
	
	# Date col name
	date_col <- glue("{event}_verify_date")
	start_col <- glue("{event}_verify_date_start")
	end_col <- glue("{event}_verify_date_end")
	type_col <- glue("{event}_verify_date_type")
	
	# Time unit col name
	month_col <- glue("{event}_verify_date_month")
	quarter_col <- glue("{event}_verify_date_quarter")
	third_col <- glue("{event}_verify_date_third")
	half_col <- glue("{event}_verify_date_half")
	
	# Add time unit columns via mutate
	bike_raw <- bike_raw %>%
		mutate(
			
			# Months (monthly)
			!!month_col := case_when(
				.data[[type_col]] %in% c("day", "month") ~ month(.data[[date_col]], label = T, abbr = F)
			),
			!!month_col := as.numeric(.data[[month_col]]),
			
			# Quarters (quarterly)
			!!quarter_col := case_when(
				month(.data[[date_col]]) %in% 1:3 |
				(
					month(.data[[start_col]]) %in% 1:3 &
					month(.data[[end_col]]) %in% 1:3 &
					year(.data[[start_col]]) == year(.data[[end_col]])
				) ~ 1,
				month(.data[[date_col]]) %in% 4:6 |
				(
					month(.data[[start_col]]) %in% 4:6 &
					month(.data[[end_col]]) %in% 4:6 &
					year(.data[[start_col]]) == year(.data[[end_col]])
				) ~ 2,
				month(.data[[date_col]]) %in% 1:3 |
				(
					month(.data[[start_col]]) %in% 7:9 &
					month(.data[[end_col]]) %in% 7:9 &
					year(.data[[start_col]]) == year(.data[[end_col]])
				) ~ 3,
				month(.data[[date_col]]) %in% 10:12 |
				(
					month(.data[[start_col]]) %in% 10:12 &
					month(.data[[end_col]]) %in% 10:12 &
					year(.data[[start_col]]) == year(.data[[end_col]])
				) ~ 4
			),
			
			# Thirds (triyearly)
			!!third_col := case_when(
				month(.data[[date_col]]) %in% 1:4 |
				(
					month(.data[[start_col]]) %in% 1:4 &
					month(.data[[end_col]]) %in% 1:4 &
					year(.data[[start_col]]) == year(.data[[end_col]])
				) ~ 1, # Fall
				month(.data[[date_col]]) %in% 5:8 |
				(
					month(.data[[start_col]]) %in% 5:8 &
					month(.data[[end_col]]) %in% 5:8 &
					year(.data[[start_col]]) == year(.data[[end_col]])
				) ~ 2, # Winter
				month(.data[[date_col]]) %in% 9:12 |
				(
					month(.data[[start_col]]) %in% 9:12 &
					month(.data[[end_col]]) %in% 9:12 &
					year(.data[[start_col]]) == year(.data[[end_col]])
				) ~ 3 # Spring/Summer
			),
			
			# Halves (biyearly)
			!!half_col := case_when(
				month(.data[[date_col]]) %in% 1:6 |
				(
					month(.data[[start_col]]) %in% 1:6 &
					month(.data[[end_col]]) %in% 1:6 &
					year(.data[[start_col]]) == year(.data[[end_col]])
				) ~ 1,
				month(.data[[date_col]]) %in% 7:12 |
				(
					month(.data[[start_col]]) %in% 7:12 &
					month(.data[[end_col]]) %in% 7:12 &
					year(.data[[start_col]]) == year(.data[[end_col]])
				) ~ 2
			)
			
		)
}

```

## Determine Unit of Time

Determine the temporal resolution (unit of time) finer than yearly based on the amount of data available per time unit.

```{r}

# Prepare plot data
unit_data <- bike_raw %>%
	as_tibble %>%
	filter(`_is_verify_post2018`) %>%
	select(
		city,
		install_verify_date_month,
		install_verify_date_quarter,
		install_verify_date_third,
		install_verify_date_half,
		upgrade1_verify_date_month,
		upgrade1_verify_date_quarter,
		upgrade1_verify_date_third,
		upgrade1_verify_date_half,
		upgrade2_verify_date_month,
		upgrade2_verify_date_quarter,
		upgrade2_verify_date_third,
		upgrade2_verify_date_half
	) %>%
	pivot_longer(
		cols = -city,
		names_to = "column",
		values_to = "value"
	) %>%
	mutate(
		type = case_when(
			str_detect(column, "month") & !is.na(value) ~ "Month",
			str_detect(column, "quarter") & !is.na(value) ~ "Quarter",
			str_detect(column, "third") & !is.na(value) ~ "Third",
			str_detect(column, "half") & !is.na(value) ~ "Half"
		)
	) %>%
	group_by(city, type) %>%
	count %>%
	filter(!is.na(type)) %>%
	ungroup %>%
	left_join( # left join totals for perc
		bike_raw %>%
			as_tibble %>%
			filter(`_is_verify_post2018`) %>%
			select(
				city,
				verify_install_year,
				verify_upgrade1_year,
				verify_upgrade2_year
			) %>%
			pivot_longer(
				cols = -city,
				names_to = "column",
				values_to = "value"
			) %>%
			filter(!is.na(value)) %>%
			group_by(city) %>%
			count %>%
			ungroup %>%
			rename(total = n),
		by = "city"
	) %>%
	mutate(
		perc = n / total * 100,
		label = glue("{round(perc, 2)}%"),
		type = factor(type, levels = c("Month", "Quarter", "Third", "Half")),
		city = factor(str_to_title(city), levels = c("Vancouver", "Calgary", "Toronto"))
	) %>%
	arrange(city, type)

# Plot line
unit_plot <- unit_data %>%
	ggplot(aes(
		x = type,
		y = perc,
		group = city,
		color = city,
		label = label
	)) +
	geom_line(
		alpha = 0.5,
		linewidth = 1.5
	) +
	geom_label(
		size = 2.5,
		position = position_dodge(width = 0.4),
		show.legend = F
	) +
	scale_x_discrete(limits = levels(unit_data$type)) +
	labs(
		x = NULL,
		y = "% of Verified Post-2018 Installs and Upgrades",
		color = "City",
		label = NULL,
		group = NULL
	)+
	theme_minimal()
unit_plot
```
