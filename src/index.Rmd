---
title: "Cycling Interventions Evaluation"
subtitle: "R Code"
author:
- "Richard Wen richard.wen@utoronto.ca"
- "Brice Batomen brice.kuimi@utoronto.ca"
- "Linda Rothman linda.rothman@torontomu.ca"
- "Andrew Howard andrew.howard@sickkids.ca"
date: "`r format(Sys.time(), '%B %d, %Y')`"
knit: |
    (function(input_rmd, ...) {
    rmarkdown::render(
        input_rmd,
        rmarkdown::html_document(
            toc = TRUE,
            toc_float = TRUE,
            highlight = "zenburn",
            code_folding = "hide",
            df_print = "paged",
            self_contained = FALSE
        ),
        output_dir = "../docs",
        output_file = "index", ...)
    })
---

```{r include = FALSE, echo = FALSE}
knitr::opts_chunk$set(
	warning = FALSE,
	message = FALSE
)
```

# Installation

1.  Install [R](https://www.r-project.org/)
2.  Install [RTools](https://cran.r-project.org/) if you are on Windows
3.  Install [RStudio](https://posit.co/download/rstudio-desktop/)

For more details, see [Software and Package Versions](#software-and-package-versions).

# Running This Code

1.  Ensure the installation steps above are completed
2.  Download a zip of the code and data [here](https://github.com/rrwen/recovr-eval/archive/refs/heads/main.zip) and unzip it
    - Code Repository: [github.com/rrwen/recovr-eval](https://github.com/rrwen/recovr-eval)
3.  In RStudio, open the [src/src.Rproj](https://github.com/rrwen/recovr-eval/blob/main/src/src.Rproj) file
4.  Then, open the [src/index.Rmd](https://github.com/rrwen/recovr-eval/blob/main/src/index.Rmd) file
5.  In RStudio:
    - Run all code: Click the `Run` drop down (top right of the code pane) and click `Run All`
    - Generate HTML version: Click `knit` (top left of code pane) and a file will be generated in `docs/index.html`

# Libraries

Install R packages if needed.

```{r, results = FALSE}

# Required packages
required_packages <- c(
	"rmarkdown",
	"bookdown",
	"knitr",
	"tidyverse",
	"purrr",
	"glue",
	"lubridate",
	"scales",
	"patchwork",
	"DiagrammeR",
	"DiagrammeRsvg",
	"webshot2",
	"magick",
	"rsvg",
	"sf",
	"tmap",
	"ggspatial",
	"prettymapr",
	"units",
	"boot"
)

# Try to install packages if not installed
default_options <- options()
tryCatch(
	{
		# Disable interactivity
		options(install.packages.compile.from.source = "always")
		
		# Install package if not installed
		for (package in required_packages) {
			is_package_installed <- require(package, character.only = TRUE)
			if (!is_package_installed) {
				cat(paste0("Installing package: ", package, "\n"))
				install.packages(package)
			} else {
				cat(paste0("Package already installed: ", package, "\n"))
			}
		}
	},
	error = function(cond) {
		stop(cond)
	},
	finally = {
		options(default_options) # reset interactivity
	}
)
```

Load R libraries.

```{r}
library(boot)
library(DiagrammeR)
library(ggplot2)
library(ggspatial)
library(glue)
library(lubridate)
library(patchwork)
library(sf)
library(tidyverse)
library(tmap)
```

# Data

Read data from the `data` folder.

```{r}
ddesc <- read_csv("../data/data.csv")
ddesc
```

## Vancouver Bikeways {.tabset}

`r ddesc %>% filter(file == "vancouver-bikeways-2024-06-02.geojson") %>% pull(description)`

* **Download Link**: `r ddesc %>% filter(file == "vancouver-bikeways-2024-06-02.geojson") %>% pull(url)`
* **Download Date**: `r format(ddesc %>% filter(file == "vancouver-bikeways-2024-06-02.geojson") %>% pull(download_date), '%B %d, %Y')`
* **Data Updated**: `r format(ddesc %>% filter(file == "vancouver-bikeways-2024-06-02.geojson") %>% pull(update_date), '%B %d, %Y')`
* **Notes**: `r ddesc %>% filter(file == "vancouver-bikeways-2024-06-02.geojson") %>% pull(notes)`

```{r}

# Read data
vancbike_raw <- read_sf("../data/vancouver-bikeways-2024-06-02.geojson")

# Get download date
vancbike_dldate <- ddesc %>% filter(
	file == "vancouver-bikeways-2024-06-02.geojson"
) %>% pull(download_date)
```

### Map

Only the first 1000 records are shown.

```{r}
tmap_mode("view")
tm_shape(vancbike_raw %>% head(1000)) +
    tm_lines(
    	col = "#336699",
    	border.col = "white",
    	popup.vars = TRUE
    )
```

### Data

* Columns: `r ncol(vancbike_raw)`
* Rows: `r nrow(vancbike_raw)`

```{r}
vancbike_raw %>% as_tibble
```

### Dictionary

The data contains the following columns:

```{r, cols.print = 3}
#vancbike_ddict <- read_csv("../data/vancouver-bikeways-2024-06-02-datadict.csv")
#vancbike_ddict
```

### Details

```{r}
print(vancbike_raw)
```

### Files

The data files are available below:

- [vancouver-bikeways-2024-06-02.geojson](https://github.com/rrwen/recovr-eval/blob/main/data/vancouver-bikeways-2024-06-02.geojson)
- [vancouver-bikeways-2024-06-02-datadict.csv](https://github.com/rrwen/recovr-eval/blob/main/data/vancouver-bikeways-2024-06-02-datadict.csv)

## Calgary Bikeways {.tabset}

`r ddesc %>% filter(file == "calgary-bikeways-2024-06-05.geojson") %>% pull(description)`

* **Download Link**: `r ddesc %>% filter(file == "calgary-bikeways-2024-06-05.geojson") %>% pull(url)`
* **Download Date**: `r format(ddesc %>% filter(file == "calgary-bikeways-2024-06-05.geojson") %>% pull(download_date), '%B %d, %Y')`
* **Data Updated**: `r format(ddesc %>% filter(file == "calgary-bikeways-2024-06-05.geojson") %>% pull(update_date), '%B %d, %Y')`
* **Notes**: `r ddesc %>% filter(file == "calgary-bikeways-2024-06-05.geojson") %>% pull(notes)`

```{r}

# Read data
calgbike_raw <- read_sf("../data/calgary-bikeways-2024-06-05.geojson")

# Get download date
calgbike_dldate <- ddesc %>% filter(
	file == "calgary-bikeways-2024-06-05.geojson"
) %>% pull(download_date)
```

### Map

Only the first 1000 records are shown.

```{r}
tmap_mode("view")
tm_shape(calgbike_raw %>% head(1000)) +
    tm_lines(
    	col = "#336699",
    	border.col = "white",
    	popup.vars = TRUE
    )
```

### Data

* Columns: `r ncol(calgbike_raw)`
* Rows: `r nrow(calgbike_raw)`

```{r}
calgbike_raw %>% as_tibble
```

### Dictionary

The data contains the following columns:

```{r, cols.print = 3}
#calgbike_ddict <- read_csv("../data/calgary-bikeways-2024-06-05-datadict.csv")
#calgbike_ddict
```

### Details

```{r}
print(calgbike_raw)
```

### Files

The data files are available below:

- [calgary-bikeways-2024-06-05.geojson](https://github.com/rrwen/recovr-eval/blob/main/data/calgary-bikeways-2024-06-05.geojson)
- [calgary-bikeways-2024-06-05-datadict.csv](https://github.com/rrwen/recovr-eval/blob/main/data/calgary-bikeways-2024-06-05-datadict.csv)

## Toronto Bikeways {.tabset}

`r ddesc %>% filter(file == "toronto-bikeways-2024-06-02.geojson") %>% pull(description)`

* **Download Link**: `r ddesc %>% filter(file == "toronto-bikeways-2024-06-02.geojson") %>% pull(url)`
* **Download Date**: `r format(ddesc %>% filter(file == "toronto-bikeways-2024-06-02.geojson") %>% pull(download_date), '%B %d, %Y')`
* **Data Updated**: `r format(ddesc %>% filter(file == "toronto-bikeways-2024-06-02.geojson") %>% pull(update_date), '%B %d, %Y')`
* **Notes**: `r ddesc %>% filter(file == "toronto-bikeways-2024-06-02.geojson") %>% pull(notes)`

```{r}

# Read data
toronbike_raw <- read_sf("../data/toronto-bikeways-2024-06-02.geojson")

# Get download date
toronbike_dldate <- ddesc %>% filter(
	file == "toronto-bikeways-2024-06-02.geojson"
) %>% pull(download_date)
```

### Map

Only the first 1000 records are shown.

```{r}
tmap_mode("view")
tm_shape(toronbike_raw %>% head(1000)) +
    tm_lines(
    	col = "#336699",
    	border.col = "white",
    	popup.vars = TRUE
    )
```

### Data

* Columns: `r ncol(toronbike_raw)`
* Rows: `r nrow(toronbike_raw)`

```{r}
toronbike_raw %>% as_tibble
```

### Dictionary

The data contains the following columns:

```{r, cols.print = 3}
#toronbike_ddict <- read_csv("../data/toronto-bikeways-2024-06-02-datadict.csv")
#toronbike_ddict
```

### Details

```{r}
print(toronbike_raw)
```

### Files

The data files are available below:

- [toronto-bikeways-2024-06-02.geojson](https://github.com/rrwen/recovr-eval/blob/main/data/toronto-bikeways-2024-06-02.geojson)
- [toronto-bikeways-2024-06-02-datadict.csv](https://github.com/rrwen/recovr-eval/blob/main/data/toronto-bikeways-2024-06-02-datadict.csv)

## Verified Dates {.tabset}

`r ddesc %>% filter(file == "verify-dates-2024-06-05.csv") %>% pull(description)`

* **Download Link**: `r ddesc %>% filter(file == "verify-dates-2024-06-05.csv") %>% pull(url)`
* **Download Date**: `r format(ddesc %>% filter(file == "verify-dates-2024-06-05.csv") %>% pull(download_date), '%B %d, %Y')`
* **Data Updated**: `r format(ddesc %>% filter(file == "verify-dates-2024-06-05.csv") %>% pull(update_date), '%B %d, %Y')`
* **Notes**: `r ddesc %>% filter(file == "verify-dates-2024-06-05.csv") %>% pull(notes)`

```{r}

# Read data
vdates_raw <- read_sf("../data/verify-dates-2024-06-05.csv")

# Get download date
vdates_dldate <- ddesc %>% filter(
	file == "verify-dates-2024-06-05.csv"
) %>% pull(download_date)
```

### Data

* Columns: `r ncol(vdates_raw)`
* Rows: `r nrow(vdates_raw)`

```{r}
vdates_raw %>% as_tibble
```

### Dictionary

The data contains the following columns:

```{r, cols.print = 3}
vdates_ddict <- read_csv("../data/verify-dates-2024-06-05-datadict.csv")
vdates_ddict
```

### Files

The data files are available below:

- [verify-dates-2024-06-05.csv](https://github.com/rrwen/recovr-eval/blob/main/data/verify-dates-2024-06-05.csv)
- [verify-dates-2024-06-05-datadict.csv](https://github.com/rrwen/recovr-eval/blob/main/data/verify-dates-2024-06-05-datadict.csv)

## Toronto KSI {.tabset}

`r ddesc %>% filter(file == "toronto-ksi-2024-06-01.geojson") %>% pull(description)`

* **Download Link**: `r ddesc %>% filter(file == "toronto-ksi-2024-06-01.geojson") %>% pull(url)`
* **Download Date**: `r format(ddesc %>% filter(file == "toronto-ksi-2024-06-01.geojson") %>% pull(download_date), '%B %d, %Y')`
* **Data Updated**: `r format(ddesc %>% filter(file == "toronto-ksi-2024-06-01.geojson") %>% pull(update_date), '%B %d, %Y')`
* **Notes**: `r ddesc %>% filter(file == "toronto-ksi-2024-06-01.geojson") %>% pull(notes)`

```{r}

# Read data
ksi_raw <- read_sf("../data/toronto-ksi-2024-06-01.geojson")

# Get download date
ksi_dldate <- ddesc %>% filter(
	file == "toronto-ksi-2024-06-01.geojson"
) %>% pull(download_date)
```

### Map

**Note**: Due to the large number of records, only the latest year of `r year(max(ksi_raw$DATE))` is displayed (n = `r ksi_raw %>% filter(year(DATE) == max(year(DATE))) %>% nrow`).

```{r}
tmap_mode("view")
tm_shape(ksi_raw %>% filter(year(DATE) == max(year(DATE)))) +
    tm_dots(
    	col = "ACCLASS",
    	clustering = TRUE,
    	popup.vars = TRUE
    )
```

### Data

* Columns: `r ncol(ksi_raw)`
* Rows: `r nrow(ksi_raw)`

```{r}
ksi_raw %>% as_tibble()
```

### Dictionary

The data contains the following columns:

```{r, cols.print = 3}
ksi_ddict <- read_csv("../data/toronto-ksi-2024-06-01-datadict.csv")
ksi_ddict
```

### Details

```{r}
print(ksi_raw)
```

### Files

The data files are available below:

- [toronto-ksi-2024-06-01.geojson](https://github.com/rrwen/recovr-eval/blob/main/data/toronto-ksi-2024-06-01.geojson)
- [toronto-ksi-2024-06-01-datadict.csv](https://github.com/rrwen/recovr-eval/blob/main/data/toronto-ksi-2024-06-01-datadict.csv)

# Cleaning

## Combine Bikeways

Combine bikeway data across all cities.

```{r}

# List of city bikeway data
bike_list <- list(
	vancouver = vancbike_raw,
	calgary = calgbike_raw %>%
		mutate(no_verify_install_type = NA),
	toronto = toronbike_raw %>%
		mutate(no_verify_install_type = NA)
)

# Get common columns across all city bikeways
bike_cols <- bike_list %>%
	map(colnames) %>%
	reduce(intersect) %>%
	c("no_verify_install_type") # include vanc lsbs

# Combine bikeway data across cities
bike <- names(bike_list) %>%
	map(function(city) {
		bike_list[[city]] %>%
			select(
				all_of(bike_cols)
			) %>%
			mutate(
				city = factor(city, levels = names(bike_list)),
				.before = 1
			)
	}) %>%
	reduce(add_row)

# Display total records per city
bike_nrow <- bike %>%
	as_tibble %>%
	group_by(city) %>%
	summarize( # total segments per city
		segments = n()
	) %>%
	ungroup %>%
	add_row( # total segment counts
		city = "all",
		segments = sum(.$segments)
	) %>%
	mutate(
		city = str_to_title(city)
	) %>%
	rename(
		`Total Segments` = segments
	) %>%
	rename_with(
		~str_to_title(.)
	)
bike_nrow
```

## Filter Verified Bikeways

Filter for bikeways with verified installations and upgrades.

```{r}

# Filter verified bikeways
vbike <- bike %>%
	filter(
		(!is.na(verify_install_year) |
		!is.na(verify_upgrade1_year) |
		!is.na(verify_upgrade2_year)) &
		is.na(no_verify_install_type)
	)

# Count verified bikeways
vbike_nrow <- vbike %>%
	as_tibble %>%
	group_by(city) %>%
	summarize( # total verified segments per city
		segments = n()
	) %>%
	ungroup %>%
	add_row( # total verified segment counts
		city = "all",
		segments = sum(.$segments)
	) %>%
	mutate(
		city = str_to_title(city)
	) %>%
	rename(`Total Verified` = segments) %>%
	rename_with(
		~str_to_title(.)
	) %>%
	left_join(bike_nrow, by = "City") %>%
	mutate(
		`Total Verified %` = `Total Verified` / `Total Segments` * 100
	) %>%
	relocate(
		"Total Verified",
		"Total Verified %",
		.after = "City"
	)
vbike_nrow
```

## Filter Verified with Dates

Filter for bikeways with verified install/upgrade dates only.

```{r}

# Filter ver install/upgrades only
vbike <- bike %>%
	filter(
		!is.na(verify_install_date) |
		!is.na(verify_upgrade2_date) |
		!is.na(verify_upgrade2_date)
	)

# Count verified bikeways with dates
vbike_nrow_vdates <- vbike %>%
	as_tibble %>%
	group_by(city) %>%
	summarize( # total verified per city
		segments = n()
	) %>%
	ungroup %>%
	add_row( # total segment counts
		city = "all",
		segments = sum(.$segments)
	) %>%
	mutate(
		city = str_to_title(city)
	) %>%
	rename(`Total Dated` = segments) %>%
	rename_with(
		~str_to_title(.)
	) %>%
	left_join(vbike_nrow, by = "City") %>%
	mutate(
		`Total Dated %` = `Total Dated` / `Total Verified` * 100
	) %>%
	relocate(
		"Total Dated",
		"Total Dated %",
		.after = "City"
	)
vbike_nrow_vdates
```

## Pivot Long and Remove Undated

Long format where each record represents an installed (`install`), first upgrade (`upgrade1`), or second upgrade (`upgrade2`) verified bikeway segment.

Also remove any segments without dates.

```{r}

# Pivot to longer format
vbike_long <- vbike %>%
	pivot_longer(
		cols = ends_with("_date"),
		names_to = "verify_event_type",
		values_to = "verify_date_raw"
	) %>%
	mutate( # convert events to install, upgrade1, upgrade2
		verify_event_type = str_replace_all(
			verify_event_type,
			c("verify_" = "", "_date" = "")
		)
	) %>%
	filter(!is.na(verify_date_raw))

# Count dated installs and upgrades
vbike_long_nrow <- vbike_long %>%
	as_tibble %>%
	group_by(city, verify_event_type) %>%
	summarize(segments = n()) %>%
	pivot_wider(
		names_from = verify_event_type,
		values_from = segments
	) %>%
	mutate(
		city = str_to_title(city)
	) %>%
	rename(
		`Dated Installs` = install,
		`Dated Upgrades (1st)` = upgrade1,
		`Dated Upgrades (2nd)` = upgrade2
	) %>%
	rename_with(
		~str_to_title(.)
	) %>%
	left_join(
		vbike_nrow_vdates,
		by = "City"
	) %>%
	mutate(
		`Dated Installs %` = `Dated Installs` / `Total Dated` * 100,
		`Dated Upgrades % (1st)` = `Dated Upgrades (1st)` / `Total Dated` * 100,
		`Dated Upgrades % (2nd)` = `Dated Upgrades (2nd)` / `Total Dated` * 100
	) %>%
	relocate(
		"Dated Installs",
		"Dated Installs %",
		"Dated Upgrades (1st)",
		"Dated Upgrades % (1st)",
		"Dated Upgrades (2nd)",
		"Dated Upgrades % (2nd)",
		.after = "City"
	)
vbike_long_nrow
```

## Clean Verified Dates

Clean manually entered ambiguous verified install/upgrade dates that had various time units (e.g. days, months, quarters, semesters, etc).

```{r}

# Clean verified dates using join
vbike_long <- vbike_long %>%
	left_join( # join cleaned dates to raw dates
		vdates_raw,
		by = "verify_date_raw"
	) %>%
	filter( # remove with no clean dates
		!is.na(verify_date_type)
	)

# Count clean dated installs and upgrades
vbike_long_nrow_clean <- vbike_long %>%
	as_tibble %>%
	group_by(city, verify_event_type) %>%
	summarize(segments = n()) %>%
	pivot_wider(
		names_from = verify_event_type,
		values_from = segments
	) %>%
	mutate(
		city = str_to_title(city)
	) %>%
	rename(
		`Clean Dated Installs` = install,
		`Clean Dated Upgrades (1st)` = upgrade1,
		`Clean Dated Upgrades (2nd)` = upgrade2
	) %>%
	rename_with(
		~str_to_title(.)
	) %>%
	left_join(
		vbike_long_nrow,
		by = "City"
	) %>%
	mutate(
		`Clean Dated Installs %` = `Clean Dated Installs` / `Dated Installs` * 100,
		`Clean Dated Upgrades % (1st)` = `Clean Dated Upgrades (1st)` / `Dated Upgrades (1st)` * 100,
		`Clean Dated Upgrades % (2nd)` = `Clean Dated Upgrades (2nd)` / `Dated Upgrades (2nd)` * 100
	) %>%
	relocate(
		"Clean Dated Installs",
		"Clean Dated Installs %",
		"Clean Dated Upgrades (1st)",
		"Clean Dated Upgrades % (1st)",
		"Clean Dated Upgrades (2nd)",
		"Clean Dated Upgrades % (2nd)",
		.after = "City"
	)
vbike_long_nrow_clean
```

## Filter 2019 or Later Bikeways

Filter for bikeways that were installed or upgraded 2019 or later.

```
# Filter ver install/upgrades 2019 or later only
vbike <- bike %>%
	filter(
		verify_install_year 
	)
```

## Determine Temporal Scale

```{r}

```
